<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>micro:bit Debug + Temp Monitor</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root { --brand:#5ddb9a; --accent:#eb7a08; }
  body {
    margin:0; font-family:sans-serif; background:var(--brand);
    display:flex; flex-direction:column; align-items:center;
  }
  h1 { color:#fff; margin:20px; }
  .block {
    background:#fff; padding:20px; margin:15px; border-radius:10px;
    box-shadow:0 0 10px #0004; width:90%; max-width:700px;
  }
  .temp-value { font-size:2.5em; color:var(--accent); }
  .status { margin-top:8px; }
  .btns { display:flex; flex-wrap:wrap; gap:8px; margin:10px 0; }
  button {
    padding:10px 16px; font-size:1em; background:#21f10a; border:none;
    border-radius:6px; cursor:pointer;
  }
  button:hover { background:#3607f1dc; color:#fff; }
  canvas { margin-top:20px; border-radius:10px; background:#eee; }
  #logBox, #activityLogBox {
    background:#000; color:#0f0; font-family:monospace;
    padding:10px; height:220px; overflow-y:auto; font-size:.9em;
    white-space:pre-wrap; margin-bottom:6px; border-radius:8px;
  }
  .muted { color:#666; font-size:.95em; }
</style>
</head>
<body>

<h1>üõ†Ô∏è micro:bit Debug + Temp Monitor</h1>

<div class="block">
  <h2>üîå USB (Any Device)</h2>
  <div id="usb-temp" class="temp-value">-- ¬∞C</div>
  <div id="usb-status" class="status">Disconnected</div>
  <div class="btns">
    <button onclick="connectUSB()">Connect USB</button>
  </div>
  <canvas id="usbChart" width="600" height="220"></canvas>
  <div class="muted">Protocol: Web Serial @115200, expects lines like <code>USB Temp:27</code></div>
</div>

<div class="block">
  <h2>üì° BLE (micro:bit)</h2>
  <div id="ble-temp" class="temp-value">-- ¬∞C</div>
  <div id="ble-status" class="status">Disconnected</div>
  <div class="btns">
    <button onclick="connectBLE_UART()">Connect BLE (UART/NUS)</button>
    <button onclick="connectBLE_ESS()">Connect BLE (ESS 0x181A)</button>
  </div>
  <canvas id="bleChart" width="600" height="220"></canvas>
  <div class="muted">UART expects lines like <code>BLE Temp:27</code>. ESS reads GATT temperature (0x2A6E).</div>
</div>

<div class="block">
  <h2>üìã Serial Log</h2>
  <div id="logBox">[LOG INIT]</div>
  <button onclick="saveDebugLog()">üì• Save Serial Log</button>
</div>

<div class="block">
  <h2>‚öôÔ∏è Activity Log</h2>
  <div id="activityLogBox">[ACTIVITY LOG INIT]</div>
  <button onclick="saveActivityLog()">üì• Save Debug Log</button>
</div>

<div class="block">
  <h2>‚¨áÔ∏è Download .HEX File (placeholder)</h2>
  <button onclick="downloadHex()">‚¨áÔ∏è Download HEX</button>
  <div class="muted">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‚Äî‡πÉ‡∏™‡πà‡πÑ‡∏ü‡∏•‡πå .hex ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏°</div>
</div>

<script>
/* ======== Chart setup ======== */
const MAX_POINTS = 30;
const usbChart = createChart("usbChart", "USB Temp (¬∞C)");
const bleChart = createChart("bleChart", "BLE Temp (¬∞C)");

function createChart(id, label){
  const ctx = document.getElementById(id).getContext('2d');
  return new Chart(ctx, {
    type:'line',
    data:{ labels:[], datasets:[{
      label, data:[],
      borderColor:'#eb7a08', backgroundColor:'rgba(235,122,8,0.2)',
      pointRadius:0, tension:0.3
    }]},
    options:{
      responsive:true, animation:false,
      scales:{
        x:{ display:false },
        y:{ min:0, max:50,
            ticks:{ stepSize:5, callback:v=>`${v}¬∞C` },
            title:{ display:true, text:'Temperature (¬∞C)' } }
      }
    }
  });
}

function updateChart(chart, temp){
  const now = new Date().toLocaleTimeString();
  chart.data.labels.push(now);
  chart.data.datasets[0].data.push(temp);
  if(chart.data.labels.length > MAX_POINTS){
    chart.data.labels.shift();
    chart.data.datasets[0].data.shift();
  }
  chart.update();
}

/* ======== Logging ======== */
let debugLogBuffer = [];
let activityLogBuffer = [];

function appendDebugLog(msg){
  const box = document.getElementById('logBox');
  const line = `[${new Date().toLocaleTimeString()}] ${msg}`;
  debugLogBuffer.push(line);
  box.textContent += '\n' + line;
  box.scrollTop = box.scrollHeight;
}

function appendActivityLog(msg){
  const box = document.getElementById('activityLogBox');
  const line = `[${new Date().toLocaleTimeString()}] ${msg}`;
  activityLogBuffer.push(line);
  box.textContent += '\n' + line;
  box.scrollTop = box.scrollHeight;
}

function saveDebugLog(){
  downloadText(debugLogBuffer.join('\n'),
    `debug-log-${ts()}.txt`);
  appendActivityLog('[SYSTEM] Debug log saved');
}
function saveActivityLog(){
  downloadText(activityLogBuffer.join('\n'),
    `activity-log-${ts()}.txt`);
  appendActivityLog('[SYSTEM] Activity log saved');
}

function downloadText(text, filename){
  const blob = new Blob([text], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
function ts(){ return new Date().toISOString().replace(/[:.]/g,'-'); }

/* ======== Helpers ======== */
function assertSecureAndSupported(kind){
  if (kind === 'ble') {
    if (!('bluetooth' in navigator))
      throw new Error('Web Bluetooth not supported (use Chrome/Edge on HTTPS or localhost)');
    if (!window.isSecureContext)
      appendActivityLog('[BLE] WARNING: Not a secure context (use HTTPS or localhost)');
  }
  if (kind === 'serial') {
    if (!('serial' in navigator))
      throw new Error('Web Serial not supported on this browser');
  }
}
function parseTempLine(prefix, line){
  if (!line.startsWith(prefix)) return null;
  const n = parseFloat(line.slice(prefix.length));
  return Number.isFinite(n) ? n : null;
}

/* ======== USB (Web Serial) ======== */
async function connectUSB(){
  const usbStatus = document.getElementById('usb-status');
  const usbTemp   = document.getElementById('usb-temp');

  appendActivityLog('[USB] Requesting port...');
  usbStatus.textContent = 'Connecting...';

  try{
    assertSecureAndSupported('serial');

    const port = await navigator.serial.requestPort();
    await port.open({ baudRate: 115200 });
    appendActivityLog('[USB] Port opened');
    usbStatus.textContent = 'Connected';

    const textDecoder = new TextDecoderStream();
    const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
    const reader = textDecoder.readable.getReader();

    let buffer = '';
    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      if (value) {
        buffer += value;
        let idx;
        while ((idx = buffer.indexOf('\n')) >= 0) {
          const line = buffer.slice(0, idx).replace(/\r+$/,'').trim();
          buffer = buffer.slice(idx + 1);
          if (!line) continue;
          appendDebugLog('[USB] ' + line);

          const t = parseTempLine('USB Temp:', line);
          if (t !== null) {
            usbTemp.textContent = t.toFixed(2) + ' ¬∞C';
            updateChart(usbChart, t);
          }
          if (line.startsWith('Chip Info:')) appendActivityLog('[USB] ' + line);
        }
      }
    }
    await readableStreamClosed.catch(()=>{});
  }catch(err){
    usbStatus.textContent = 'Error: ' + err.message;
    appendActivityLog('[USB] ERROR: ' + err.message);
  }
}

/* ======== BLE (UART over NUS) ======== */
async function connectBLE_UART(){
  const bleStatus = document.getElementById('ble-status');
  const bleTemp   = document.getElementById('ble-temp');

  const NUS_SERVICE = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
  const NUS_RX      = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // write (optional)
  const NUS_TX      = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // notify

  bleStatus.textContent = 'Connecting...';
  appendActivityLog('[BLE] Requesting device (filter=NUS)...');

  try{
    assertSecureAndSupported('ble');

    const device = await navigator.bluetooth.requestDevice({
      filters: [{ services: [NUS_SERVICE] }]
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏£‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠: , { namePrefix: 'BBC micro:bit' }
    });

    appendActivityLog('[BLE] Device selected: ' + (device.name || '(no name)'));
    device.addEventListener('gattserverdisconnected', () => {
      appendActivityLog('[BLE] Disconnected');
      bleStatus.textContent = 'Disconnected';
    });

    const server = await device.gatt.connect();
    appendActivityLog('[BLE] GATT connected');

    // ‡∏î‡∏µ‡∏ö‡∏±‡∏Å: ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô services
    const svcs = await server.getPrimaryServices();
    appendActivityLog('[BLE] Services count: ' + svcs.length);

    const service = await server.getPrimaryService(NUS_SERVICE);
    const txChar  = await service.getCharacteristic(NUS_TX);

    if (!txChar.properties.notify) {
      throw new DOMException('TX characteristic has no notify property', 'NotSupportedError');
    }

    await txChar.startNotifications();
    appendActivityLog('[BLE] Notifications started');

    let buffer = '';
    txChar.addEventListener('characteristicvaluechanged', (event) => {
      const chunk = new TextDecoder().decode(event.target.value);
      buffer += chunk;
      let idx;
      while ((idx = buffer.indexOf('\n')) >= 0) {
        const line = buffer.slice(0, idx).replace(/\r+$/,'').trim();
        buffer = buffer.slice(idx + 1);
        if (!line) continue;
        appendDebugLog('[BLE] ' + line);

        const t = parseTempLine('BLE Temp:', line);
        if (t !== null) {
          bleTemp.textContent = t.toFixed(2) + ' ¬∞C';
          updateChart(bleChart, t);
        } else if (line.startsWith('Chip Info:')) {
          appendActivityLog('[BLE] ' + line);
        }
      }
    });

    // (‡∏≠‡∏≠‡∏õ‡∏ä‡∏±‡∏ô) ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏≤ micro:bit
    // const rxChar = await service.getCharacteristic(NUS_RX);
    // await rxChar.writeValue(new TextEncoder().encode('ping\n'));

    bleStatus.textContent = 'Connected (UART)';
    appendActivityLog('[BLE] Connected and listening (UART)');
  }catch(err){
    bleStatus.textContent = 'Error: ' + err.message;
    appendActivityLog('[BLE] ERROR: ' + (err.name ? err.name + ': ' : '') + err.message);

    if (err.name === 'NotSupportedError') {
      appendActivityLog('[BLE] HINT: ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤ micro:bit ‡∏£‡∏±‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å bluetooth.startUartService() ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡∏ß');
    }
  }
}

/* ======== BLE (Environmental Sensing Service) ======== */
async function connectBLE_ESS(){
  const bleStatus = document.getElementById('ble-status');
  const bleTemp   = document.getElementById('ble-temp');

  // 16-bit UUIDs (Chrome ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏ê‡∏≤‡∏ô‡∏™‡∏¥‡∏ö‡∏´‡∏Å‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á)
  const ESS_SERVICE  = 0x181A; // environmental_sensing
  const TEMP_CHAR    = 0x2A6E; // temperature (¬∞C * 100, ‡∏´‡∏£‡∏∑‡∏≠ float ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå)

  bleStatus.textContent = 'Connecting...';
  appendActivityLog('[BLE-ESS] Requesting device (filter=0x181A)...');

  try{
    assertSecureAndSupported('ble');

    const device = await navigator.bluetooth.requestDevice({
      filters: [{ services: [ESS_SERVICE] }]
    });

    appendActivityLog('[BLE-ESS] Device selected: ' + (device.name || '(no name)'));
    device.addEventListener('gattserverdisconnected', () => {
      appendActivityLog('[BLE-ESS] Disconnected');
      bleStatus.textContent = 'Disconnected';
    });

    const server  = await device.gatt.connect();
    const service = await server.getPrimaryService(ESS_SERVICE);
    const ch      = await service.getCharacteristic(TEMP_CHAR);

    let useNotify = false;
    if (ch.properties.notify) {
      await ch.startNotifications();
      useNotify = true;
      ch.addEventListener('characteristicvaluechanged', e => {
        const t = decodeTempESS(e.target.value);
        if (t !== null) {
          bleTemp.textContent = t.toFixed(2) + ' ¬∞C';
          updateChart(bleChart, t);
          appendDebugLog('[BLE-ESS] ' + t.toFixed(2) + ' ¬∞C');
        }
      });
    }

    bleStatus.textContent = useNotify ? 'Connected (ESS notify)' : 'Connected (ESS polling)';
    appendActivityLog('[BLE-ESS] ' + (useNotify ? 'Notifications started' : 'No notify; fallback to polling @1s'));

    if (!useNotify) {
      // Poll ‡∏ó‡∏∏‡∏Å 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ notify
      const poll = async () => {
        try {
          const v = await ch.readValue();
          const t = decodeTempESS(v);
          if (t !== null) {
            bleTemp.textContent = t.toFixed(2) + ' ¬∞C';
            updateChart(bleChart, t);
            appendDebugLog('[BLE-ESS] ' + t.toFixed(2) + ' ¬∞C');
          }
        } catch(e) {
          appendActivityLog('[BLE-ESS] Read error: ' + e.message);
        }
      };
      poll();
      window._essTimer && clearInterval(window._essTimer);
      window._essTimer = setInterval(poll, 1000);
    }
  }catch(err){
    bleStatus.textContent = 'Error: ' + err.message;
    appendActivityLog('[BLE-ESS] ERROR: ' + (err.name ? err.name + ': ' : '') + err.message);
    window._essTimer && clearInterval(window._essTimer);
  }
}

// ‡∏ï‡∏±‡∏ß‡∏ñ‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô 0x2A6E: ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô ¬∞C ‡πÅ‡∏ö‡∏ö sfloat/int16 ‡∏´‡∏£‡∏∑‡∏≠ 0.01¬∞C
function decodeTempESS(dataView){
  // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏î‡∏≤‡∏Å‡πà‡∏≠‡∏ô: ‡∏ñ‡πâ‡∏≤ length >= 2 ‡πÉ‡∏ä‡πâ int16/100
  if (dataView.byteLength >= 2) {
    const raw = dataView.getInt16(0, /*littleEndian=*/true);
    // ‡∏õ‡∏Å‡∏ï‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÉ‡∏ä‡πâ‡∏´‡∏ô‡πà‡∏ß‡∏¢ 0.01 ¬∞C
    return raw / 100;
  }
  // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô float32
  if (dataView.byteLength >= 4) {
    return dataView.getFloat32(0, true);
  }
  return null;
}

/* ======== HEX download (placeholder) ======== */
function downloadHex(){
  const hexContent=`:020000040000FA
:0400000A9900C0DEBB
:20000000C0070000D1060000D1000000B10600000000000000000000000000000000000`;
  const blob=new Blob([hexContent],{type:'application/octet-stream'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download='microbit-program.hex';
  document.body.appendChild(a); a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  appendActivityLog('[SYSTEM] HEX file downloaded');
}
</script>

</body>
  </html>
